
name: Deploy to Oracle VM (Ubuntu)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node (Runner only)
        uses: actions/setup-node@v4
        with:
          node-version: 24.11.1

      - name: Prepare SSH known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${{ secrets.ORACLE_SSH_PORT }}" "${{ secrets.ORACLE_HOST }}" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Copy repository to server
        uses: appleboy/scp-action@v0.1.6
        with:
          host: ${{ secrets.ORACLE_HOST }}
          username: ${{ secrets.ORACLE_USER }}
          port: ${{ secrets.ORACLE_SSH_PORT }}
          key: ${{ secrets.ORACLE_SSH_KEY }}
          source: |
            .
          target: "/home/${{ secrets.ORACLE_USER }}/app"
          rm: true

      - name: Run remote deploy script (Ubuntu)
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.ORACLE_HOST }}
          username: ${{ secrets.ORACLE_USER }}
          port: ${{ secrets.ORACLE_SSH_PORT }}
          key: ${{ secrets.ORACLE_SSH_KEY }}
          script: |
            bash << 'EOF'
            set -euo pipefail

            # Try to load NVM for non-interactive shell (Ubuntu)
            if [ -s "$HOME/.nvm/nvm.sh" ]; then
              . "$HOME/.nvm/nvm.sh"
            fi

            REQUIRED_NODE="24.11.1"
            REQUIRED_NPM="11.6.2"

            ensure_node() {
              if command -v nvm >/dev/null 2>&1; then
                # Install/use exact Node version via nvm
                if ! nvm ls "$REQUIRED_NODE" >/dev/null 2>&1; then
                  echo "Installing Node $REQUIRED_NODE via nvm..."
                  nvm install "$REQUIRED_NODE"
                fi
                nvm use "$REQUIRED_NODE"
              fi

              # If nvm isn't available, ensure system node exists (Ubuntu)
              if ! command -v node >/dev/null 2>&1; then
                echo "Node not found. Installing Node 24.x via NodeSource (Ubuntu)..."
                curl -fsSL https://deb.nodesource.com/setup_24.x | sudo -E bash -
                sudo apt-get update -y
                sudo apt-get install -y nodejs
              fi

              # Verify versions
              NODE_VER="$(node -v | sed 's/^v//')"
              NPM_VER="$(npm -v)"
              echo "Node.js version: $NODE_VER (required: $REQUIRED_NODE)"
              echo "npm version: $NPM_VER (required: $REQUIRED_NPM)"

              if [ "$NODE_VER" != "$REQUIRED_NODE" ]; then
                echo "ERROR: Node.js version mismatch. Expected $REQUIRED_NODE but got $NODE_VER"
                exit 1
              fi

              if [ "$NPM_VER" != "$REQUIRED_NPM" ]; then
                echo "ERROR: npm version mismatch. Expected $REQUIRED_NPM but got $NPM_VER"
                exit 1
              fi
            }

            ensure_node

            # Deploy app
            cd "$HOME/app"
            chmod +x ./deploy.sh || true

            # PM2 environment (default 'production' if not provided)
            export PM2_ENV="${PM2_ENV:-production}"

            ./deploy.sh
            EOF
        env:
          PM2_ENV: ${{ secrets.PM2_ENV }}
